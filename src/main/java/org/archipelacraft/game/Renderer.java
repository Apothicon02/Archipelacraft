package org.archipelacraft.game;

import org.archipelacraft.Main;
import org.joml.*;
import org.archipelacraft.engine.*;
import org.archipelacraft.engine.Window;
import org.lwjgl.system.MemoryStack;

import java.io.IOException;

import static org.lwjgl.opengl.GL46.*;

public class Renderer {
    public static ShaderProgram scene;
    public static ShaderProgram debug;
    public static int sceneVaoId;
    public static int debugVaoId;

    public static int rasterFBOId;

    public static int rasterColorId;
    public static int rasterDepthId;

    public static int voxelsSSBOId;

    public static boolean showUI = true;

    public static boolean resized = false;
    public static int gigabyte = 1000000000;

    public static void createGLDebugger() {
        glEnable(GL_DEBUG_OUTPUT);
        glEnable(GL_DEBUG_OUTPUT_SYNCHRONOUS);
        glDebugMessageCallback((source, type, id, severity, length, message, userParam) -> {
            String msg = GLDebug.decode(source, type, id, severity, length, message, userParam);
            if (msg != null) {
                System.out.println(msg);
            }
        }, 0);
    }

    public static void generateVaos() {
        sceneVaoId = glGenVertexArrays();
        glBindVertexArray(sceneVaoId);
        glBindBuffer(GL_ARRAY_BUFFER, glGenBuffers());
        glBufferData(GL_ARRAY_BUFFER, new float[]{
                -1, -1, 0,
                3, -1, 0,
                -1, 3, 0
        }, GL_STATIC_DRAW);
        glVertexAttribPointer(0, 3, GL_FLOAT, false, 0, 0);

        debugVaoId = glGenVertexArrays();
        glBindVertexArray(debugVaoId);
        glBindBuffer(GL_ARRAY_BUFFER, glGenBuffers());
        glBufferData(GL_ARRAY_BUFFER, new float[]{
                -0.5f,-0.5f,-0.5f, // triangle 1 : begin
                -0.5f,-0.5f, 0.5f,
                -0.5f, 0.5f, 0.5f, // triangle 1 : end
                0.5f, 0.5f,-0.5f, // triangle 2 : begin
                -0.5f,-0.5f,-0.5f,
                -0.5f, 0.5f,-0.5f, // triangle 2 : end
                0.5f,-0.5f, 0.5f,
                -0.5f,-0.5f,-0.5f,
                0.5f,-0.5f,-0.5f,
                0.5f, 0.5f,-0.5f,
                0.5f,-0.5f,-0.5f,
                -0.5f,-0.5f,-0.5f,
                -0.5f,-0.5f,-0.5f,
                -0.5f, 0.5f, 0.5f,
                -0.5f, 0.5f,-0.5f,
                0.5f,-0.5f, 0.5f,
                -0.5f,-0.5f, 0.5f,
                -0.5f,-0.5f,-0.5f,
                -0.5f, 0.5f, 0.5f,
                -0.5f,-0.5f, 0.5f,
                0.5f,-0.5f, 0.5f,
                0.5f, 0.5f, 0.5f,
                0.5f,-0.5f,-0.5f,
                0.5f, 0.5f,-0.5f,
                0.5f,-0.5f,-0.5f,
                0.5f, 0.5f, 0.5f,
                0.5f,-0.5f, 0.5f,
                0.5f, 0.5f, 0.5f,
                0.5f, 0.5f,-0.5f,
                -0.5f, 0.5f,-0.5f,
                0.5f, 0.5f, 0.5f,
                -0.5f, 0.5f,-0.5f,
                -0.5f, 0.5f, 0.5f,
                0.5f, 0.5f, 0.5f,
                -0.5f, 0.5f, 0.5f,
                0.5f,-0.5f, 0.5f
        }, GL_STATIC_DRAW);
        glVertexAttribPointer(0, 3, GL_FLOAT, false, 0, 0);
    }
    public static void createBuffers() {
        voxelsSSBOId = glCreateBuffers();
    }

    public static void init(Window window) throws Exception {
        createGLDebugger();
        scene = new ShaderProgram("scene.vert", new String[]{"scene.frag"},
                new String[]{"projection", "view", "selected", "ui", "res"});
        debug = new ShaderProgram("debug.vert", new String[]{"debug.frag"},
                new String[]{"projection", "view", "model", "selected", "ui", "res"});
        generateVaos();
        createBuffers();

        rasterFBOId = glGenFramebuffers();

        glBindFramebuffer(GL_FRAMEBUFFER, rasterFBOId);
        
        rasterColorId = glGenTextures();
        glBindTexture(GL_TEXTURE_2D, rasterColorId);
        glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);
        glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);
        glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
        glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
        glTexStorage2D(GL_TEXTURE_2D, 1, GL_RGBA32F, window.getWidth(), window.getHeight());
        glFramebufferTexture2D(GL_FRAMEBUFFER, GL_COLOR_ATTACHMENT0, GL_TEXTURE_2D, rasterColorId, 0);


        rasterDepthId = glGenTextures();
        glBindTexture(GL_TEXTURE_2D, rasterDepthId);
        glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST);
        glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST);
        glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_S, GL_CLAMP_TO_EDGE);
        glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_WRAP_T, GL_CLAMP_TO_EDGE);
        glTexStorage2D(GL_TEXTURE_2D, 1, GL_DEPTH_COMPONENT32F, window.getWidth(), window.getHeight());
        glFramebufferTexture2D(GL_FRAMEBUFFER, GL_DEPTH_ATTACHMENT, GL_TEXTURE_2D, rasterDepthId, 0);
    }

    public static void  updateUniforms(ShaderProgram program, Window window) {
        try(MemoryStack stack = MemoryStack.stackPush()) {
            glUniformMatrix4fv(program.uniforms.get("projection"), false, window.updateProjectionMatrix().get(stack.mallocFloat(16)));
        }
        try (MemoryStack stack = MemoryStack.stackPush()) {
            glUniformMatrix4fv(program.uniforms.get("view"), false, new Matrix4f(Main.player.getCameraMatrix()).get(stack.mallocFloat(16)));
        }
        Vector3f selected = Main.raycast(new Matrix4f(Main.player.getCameraMatrix()), true, Main.reach);
        if (selected == null) {
            selected = new Vector3f(-1000, -1000, -1000);
        }
        glUniform3i(program.uniforms.get("selected"), (int) selected.x, (int) selected.y, (int) selected.z);
        glUniform1i(program.uniforms.get("ui"), showUI ? 1 : 0);
    }

    public static void updateVoxelBuffer() {
        glBindBuffer(GL_SHADER_STORAGE_BUFFER, voxelsSSBOId);
        glBindBufferBase(GL_SHADER_STORAGE_BUFFER, 0, voxelsSSBOId);
        glBufferData(GL_SHADER_STORAGE_BUFFER, World.voxels, GL_DYNAMIC_DRAW);
        glBindBuffer(GL_SHADER_STORAGE_BUFFER, 0);
    }

    public static void draw() {
        glBindVertexArray(sceneVaoId);
        glEnableVertexAttribArray(0);
        glDrawArrays(GL_TRIANGLES, 0, 3);
        glDisableVertexAttribArray(0);
    }
    public static void drawDebug() {
        glBindVertexArray(debugVaoId);
        glEnableVertexAttribArray(0);
        glDrawArrays(GL_TRIANGLES, 0, 12*3);
        glDisableVertexAttribArray(0);
    }
    public static void drawLowerCorner() {
        try(MemoryStack stack = MemoryStack.stackPush()) {
            glUniformMatrix4fv(debug.uniforms.get("model"), false, new Matrix4f().translate(-0.5f, -0.5f, -0.5f).get(stack.mallocFloat(16)));
        }
        drawDebug();
        try(MemoryStack stack = MemoryStack.stackPush()) {
            glUniformMatrix4fv(debug.uniforms.get("model"), false, new Matrix4f().translate(-0.5f, 0.5f, -0.5f).get(stack.mallocFloat(16)));
        }
        drawDebug();
        try(MemoryStack stack = MemoryStack.stackPush()) {
            glUniformMatrix4fv(debug.uniforms.get("model"), false, new Matrix4f().translate(-0.5f, -0.5f, 0.5f).get(stack.mallocFloat(16)));
        }
        drawDebug();
        try(MemoryStack stack = MemoryStack.stackPush()) {
            glUniformMatrix4fv(debug.uniforms.get("model"), false, new Matrix4f().translate(0.5f, -0.5f, -0.5f).get(stack.mallocFloat(16)));
        }
        drawDebug();
    }
    public static void drawUpperCorner() {
        try(MemoryStack stack = MemoryStack.stackPush()) {
            glUniformMatrix4fv(debug.uniforms.get("model"), false, new Matrix4f().translate(8.5f, 8.5f, 8.5f).get(stack.mallocFloat(16)));
        }
        drawDebug();
        try(MemoryStack stack = MemoryStack.stackPush()) {
            glUniformMatrix4fv(debug.uniforms.get("model"), false, new Matrix4f().translate(8.5f, 7.5f, 8.5f).get(stack.mallocFloat(16)));
        }
        drawDebug();
        try(MemoryStack stack = MemoryStack.stackPush()) {
            glUniformMatrix4fv(debug.uniforms.get("model"), false, new Matrix4f().translate(8.5f, 8.5f, 7.5f).get(stack.mallocFloat(16)));
        }
        drawDebug();
        try(MemoryStack stack = MemoryStack.stackPush()) {
            glUniformMatrix4fv(debug.uniforms.get("model"), false, new Matrix4f().translate(7.5f, 8.5f, 8.5f).get(stack.mallocFloat(16)));
        }
        drawDebug();
    }
    public static void render(Window window) throws IOException {
        if (!Main.isClosing) {
            glBindFramebuffer(GL_FRAMEBUFFER, rasterFBOId);
            glClearColor(0, 0, 0, 0);
            glClearDepthf(0.f);
            glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
            debug.bind();
            updateUniforms(debug, window);
            drawLowerCorner();
            drawUpperCorner();

            glBindFramebuffer(GL_FRAMEBUFFER, 0);
            glClearColor(0, 0, 0, 0);
            glClearDepthf(0.f);
            glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT);
            scene.bind();
            updateUniforms(scene, window);
            glBindTextureUnit(0, rasterColorId);
            glBindTextureUnit(1, rasterDepthId);
            updateVoxelBuffer();
            glUniform2i(scene.uniforms.get("res"), window.getWidth(), window.getHeight());

            draw();
        }
    }
}